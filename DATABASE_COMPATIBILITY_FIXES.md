# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ë–î –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

**–î–∞—Ç–∞:** 2025-10-16
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ë–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (`types/models.ts`)

#### Worker
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–æ–ª—å `'crew'` (—É–∂–µ –±—ã–ª–∞)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª–µ–π –≤ –ë–î
- ‚úÖ `skills` —Ç–µ–ø–µ—Ä—å `string[]` –≤–º–µ—Å—Ç–æ `Record<string, any>`

#### Project
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã: `'draft' | 'planning' | 'active' | 'waiting_invoice' | 'closed'`
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è (`completed_length_m`, `end_date`, `description`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª–µ–π –ë–î

#### Segment
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã: `'open' | 'in_progress' | 'done'` (–≤–º–µ—Å—Ç–æ pending/completed)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: `surface`, `area`, `depthReqM`, `widthReqM`, `geomLine`
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ: `code`, `lengthDoneM`, `createdAt`, `updatedAt`

#### WorkEntry - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø**
- ‚úÖ **–£–¥–∞–ª–µ–Ω workflow `status`** ('draft', 'submitted', etc.)
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ `approved: boolean`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `stageCode: StageCode` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ `workType`
- ‚úÖ –ü–æ–ª–µ `date` (date) –≤–º–µ—Å—Ç–æ `startTime`/`endTime` (timestamp)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:
  - `method: WorkMethod`
  - `widthM`, `depthM`, `cablesCount`
  - `hasProtectionPipe`, `soilType`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã `cabinetId`, `cutId`, `houseId` –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä–∞–±–æ—Ç

#### Photo
- ‚úÖ **–ò–∑–º–µ–Ω–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π**:
  - `url` –≤–º–µ—Å—Ç–æ `filePath`
  - `ts` –≤–º–µ—Å—Ç–æ `takenAt`
  - `gpsLat`/`gpsLon` –≤–º–µ—Å—Ç–æ `latitude`/`longitude`
  - `authorUserId` –≤–º–µ—Å—Ç–æ `takenBy`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `label: PhotoLabel` ('before' | 'during' | 'after' | 'instrument' | 'other')
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã: `filename`, `thumbnailPath`, `photoType`, `locationPoint`

#### Crew & CrewMember
- ‚úÖ `CrewMember` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `activeFrom`/`activeTo` (date) –≤–º–µ—Å—Ç–æ `is_active` (boolean)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `roleInCrew: 'foreman' | 'operator' | 'worker'`
- ‚úÖ `Crew.foremanUserId` –≤–º–µ—Å—Ç–æ `leaderUserId`

#### –ù–æ–≤—ã–µ —Ç–∏–ø—ã
- ‚úÖ `StageCode` - 10 —ç—Ç–∞–ø–æ–≤ —Ä–∞–±–æ—Ç (stage_1_marking, stage_2_excavation, etc.)
- ‚úÖ `WorkMethod` - –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã (mole, hand, excavator, trencher, documentation)
- ‚úÖ `PhotoLabel` - –º–µ—Ç–∫–∏ —Ñ–æ—Ç–æ
- ‚úÖ `CrewRole` - —Ä–æ–ª–∏ –≤ –±—Ä–∏–≥–∞–¥–µ
- ‚úÖ `StageDef` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ç–∞–ø–æ–≤ –∏–∑ –ë–î

#### –£–¥–∞–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
- ‚ùå `SegmentWorkEntry` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
- ‚ùå `WorkStage` - –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `StageDef` –∏–∑ –ë–î
- ‚ùå `DynamicField`, `ChecklistItem` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ

### 2. –•—É–∫–∏ (`lib/hooks/use-projects.ts`)

#### useProjects
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è `crew_members` –ø–æ `active_to` –≤–º–µ—Å—Ç–æ `is_active`:
  ```typescript
  .or(`active_to.is.null,active_to.gte.${today}`, { foreignTable: 'crews.crew_members' })
  ```
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–µ–∫—Ç–æ–≤: `['draft', 'planning', 'active']`

## ‚ö†Ô∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã:

1. **–û–±–Ω–æ–≤–∏—Ç—å —Ö—É–∫–∏ —Ä–∞–±–æ—Ç—ã —Å work_entries** (`lib/hooks/use-work-entries.ts`):
   - ‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è `status` workflow
   - ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `approved` boolean
   - ‚ùå –ò–∑–º–µ–Ω–∏—Ç—å `startTime`/`endTime` –Ω–∞ `date`
   - ‚ùå –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `stageCode`

2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI**:
   - ‚ùå `WorkEntryStatus` - —É–±—Ä–∞—Ç—å workflow, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ approve/reject
   - ‚ùå `WorkEntryList` - —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã draft/submitted/returned
   - ‚ùå `WorkEntryDetail` - –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–æ–≤—ã–µ –ø–æ–ª—è
   - ‚ùå `ProgressEntryForm` - —Ñ–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ WorkEntry
   - ‚ùå `PhotoUpload` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π

3. **–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã**:
   - ‚ùå `/approvals` - —É–ø—Ä–æ—Å—Ç–∏—Ç—å (—Ç–æ–ª—å–∫–æ approved/not approved)
   - ‚ùå –£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å workflow —Å—Ç–∞—Ç—É—Å–∞–º–∏

4. **–û–±–Ω–æ–≤–∏—Ç—å offline DB** (`lib/offline/db.ts`):
   - ‚ùå –°—Ö–µ–º–∞ IndexedDB –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ–≤—ã–º –º–æ–¥–µ–ª—è–º

## üìã –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### Workflow —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:
1. **–í—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞** ‚Üí `/projects`
2. **–í—ã–±–æ—Ä –ù–í–¢ (Cabinet)** ‚Üí `/projects/{id}` ‚Üí —Å–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤
3. **–í—ã–±–æ—Ä/—Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞** ‚Üí –Ω–∞ –ù–í–¢ —Å–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
4. **–°–æ–∑–¥–∞–Ω–∏–µ work_entry –ø–æ —ç—Ç–∞–ø—É**:
   - –í—ã–±—Ä–∞—Ç—å `stageCode` (—Ä–∞–∑–º–µ—Ç–∫–∞, –≤—Å–∫–æ–ø–∫–∞, –∏ —Ç.–¥.)
   - –£–∫–∞–∑–∞—Ç—å `metersDoneM` - —Å–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ —Å–¥–µ–ª–∞–Ω–æ
   - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: `method`, `widthM`, `depthM`, `cablesCount`, etc.
   - –ü—Ä–∏–ª–æ–∂–∏—Ç—å —Ñ–æ—Ç–æ
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å!)
5. **"–û—Ç–ø—Ä–∞–≤–∫–∞" = –ø—Ä–æ—Å—Ç–æ approved: false**
   - –ê–¥–º–∏–Ω —É–≤–∏–¥–∏—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å `approved: false`
   - –£—Ç–≤–µ—Ä–¥–∏—Ç ‚Üí `approved: true`, `approvedBy`, `approvedAt`

### –ù–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤!
- ‚ùå –ù–µ—Ç 'draft'
- ‚ùå –ù–µ—Ç 'submitted'
- ‚ùå –ù–µ—Ç 'returned'
- ‚úÖ –¢–æ–ª—å–∫–æ `approved: boolean`

## üéØ StageCode —ç—Ç–∞–ø—ã (—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ)

```typescript
stage_1_marking      // –†–∞–∑–º–µ—Ç–∫–∞
stage_2_excavation   // –í—Å–∫–æ–ø–∫–∞
stage_3_conduit      // –ü—Ä–æ–∫–ª–∞–¥–∫–∞ —Ç—Ä—É–±—ã
stage_4_cable        // –ü—Ä–æ–∫–ª–∞–¥–∫–∞ –∫–∞–±–µ–ª—è
stage_5_splice       // –°–ø–ª–∞–π—Å–∏–Ω–≥
stage_6_test         // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
stage_7_connect      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
stage_8_final        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
stage_9_backfill     // –ó–∞—Å—ã–ø–∫–∞
stage_10_surface     // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è
```

–≠—Ç–∏ —ç—Ç–∞–ø—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ —Ç–∞–±–ª–∏—Ü–µ `stage_defs`.

## üìä –°–≤—è–∑–∏ –≤ –ë–î

```
Project (–ø—Ä–æ–µ–∫—Ç)
  ‚Üì
Cabinet/NV–¢ (—à–∫–∞—Ñ, —Ç–æ—á–∫–∞ —Ä–∞–∑–¥–∞—á–∏)
  ‚Üì
Segment (—Å–µ–≥–º–µ–Ω—Ç –∫–∞–±–µ–ª—å–Ω–æ–π —Ç—Ä–∞—Å—Å—ã, 100–º)
  ‚Üì
WorkEntry (–∑–∞–ø–∏—Å—å –æ —Ä–∞–±–æ—Ç–µ: 10–º, stage_1_marking)
  ‚Üì
Photo (—Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã)
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–¥–º–∏–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

### –ß–µ—Ä–µ–∑ Supabase Realtime (–±—É–¥—É—â–µ–µ):
- –ê–¥–º–∏–Ω —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí worker –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- Worker —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å ‚Üí –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ü–æ–∫–∞ —á—Ç–æ:
- Worker —Å–æ–∑–¥–∞–µ—Ç `work_entry` —Å `approved: false`
- –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤ —Å–≤–æ–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –ê–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç `approved: true` + `approved_by` + `approved_at`
- Worker –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç ‚Üí –≤–∏–¥–∏—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

| –§–∏—á–∞ | Worker PWA | Admin DB | –°—Ç–∞—Ç—É—Å |
|------|-----------|----------|--------|
| User role 'crew' | ‚úÖ | ‚úÖ | –°–æ–≤–º–µ—Å—Ç–∏–º–æ |
| PIN –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | ‚úÖ | ‚úÖ | –°–æ–≤–º–µ—Å—Ç–∏–º–æ |
| Crew members active dates | ‚úÖ | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| Project statuses | ‚úÖ | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| Segment statuses | ‚úÖ | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| WorkEntry approved | ‚úÖ | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| StageCode | ‚úÖ | ‚úÖ | –î–æ–±–∞–≤–ª–µ–Ω–æ |
| Photo fields | ‚úÖ | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| Workflow status | ‚ùå | ‚ùå | –£–¥–∞–ª–µ–Ω |

## üöß TODO

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `use-work-entries.ts`
- [ ] –£–¥–∞–ª–∏—Ç—å/–ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å `WorkEntryStatus` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –£–ø—Ä–æ—Å—Ç–∏—Ç—å `/approvals` —Å—Ç—Ä–∞–Ω–∏—Ü—É
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ WorkEntry —Å stageCode
- [ ] –û–±–Ω–æ–≤–∏—Ç—å offline DB —Å—Ö–µ–º—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä Cabinet/Segment –≤ UI
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ work_entry
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ
