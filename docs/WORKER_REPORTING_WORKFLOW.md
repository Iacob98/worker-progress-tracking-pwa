# Worker Reporting Workflow - Рабочий процесс отчетности

## Обзор системы

Два приложения работают с одной базой данных:
- **Worker PWA** (текущий проект) - мобильное приложение для работников
- **Admin App** (другой проект) - веб-приложение для администраторов и бригадиров

## Workflow работника

### 1. Авторизация
```
Работник вводит:
- Email (например: K1_4@kometa.com)
- PIN код (например: 6850)
```

### 2. Выбор проекта
```
GET /projects
→ Показать список проектов, к которым работник имеет доступ
→ Работник выбирает проект
```

### 3. Выбор объекта (NVT/Cabinet)
```
GET /projects/{projectId}
→ Показать список НВТ (cabinets) на проекте
→ Каждый НВТ содержит:
  - Код НВТ (например: NVT-001)
  - Адрес
  - Статус (pending/in_progress/completed)
  - Прогресс (completed_length_m / total_length_m)
  - Количество сегментов
  - Список домов для подключения
```

### 4. Работа с трассой (Segments)

#### 4.1 Просмотр/создание сегментов
```
GET /nvt/{nvtId}
→ Показать:
  - Список сегментов трассы (каждый ~100м)
  - Для каждого сегмента:
    * Название
    * Длина (length_planned_m)
    * Поверхность (surface: asphalt/concrete/pavers/green)
    * Область (area: roadway/sidewalk/driveway/green)
    * Статус (open/in_progress/done)
    * История работ (work_entries)

Кнопка: "Создать новый сегмент"
```

#### 4.2 Создание сегмента работы
```
POST /segments
{
  cabinet_id: "uuid",
  name: "Segment A-B 100m",
  length_planned_m: 100,
  surface: "asphalt",
  area: "roadway",
  depth_req_m: 0.6,
  width_req_m: 0.3,
  status: "open"
}
```

### 5. Создание отчета о работе (Work Entry)

Работник выбирает сегмент и создает отчет:

```typescript
POST /work_entries
{
  // Основная информация
  project_id: "uuid",
  cabinet_id: "uuid",  // НВТ
  segment_id: "uuid",  // Сегмент трассы
  crew_id: "uuid",     // Бригада (автоматически)
  user_id: "uuid",     // Работник (автоматически)
  date: "2025-10-20",  // Дата работы

  // Этап работы (выбор из списка)
  stage_code: "stage_2_excavation",  // или другой этап

  // Объем работ
  meters_done_m: 25.5,  // Сколько метров сделано

  // Метод работы
  method: "excavator",  // mole/hand/excavator/trencher/documentation

  // Детали (опционально)
  width_m: 0.35,          // Ширина траншеи
  depth_m: 0.65,          // Глубина траншеи
  cables_count: 2,        // Количество кабелей
  has_protection_pipe: true,  // Есть защитная труба
  soil_type: "clay",      // Тип грунта

  // Комментарии
  notes: "Хорошая погода, работа идет быстро",

  // Статус
  approved: false  // Автоматически false при создании
}
```

### 6. Добавление фотографий

К каждому отчету можно прикрепить фото:

```typescript
POST /photos
{
  work_entry_id: "uuid",
  url: "project_id/user_id/entry_id/photo_id.jpg",  // Путь в Supabase Storage
  ts: "2025-10-20T14:30:00Z",  // Время съемки
  gps_lat: 55.7558,  // GPS координаты
  gps_lon: 37.6173,
  author_user_id: "uuid",
  label: "during"  // before/during/after/instrument/other
}

Типы фото:
- before: До начала работы
- during: В процессе работы
- after: После завершения
- instrument: Показания приборов/замеры
- other: Прочее
```

### 7. Этапы работы (Stage Codes)

Система поддерживает 10 этапов:

```typescript
stage_1_marking      // Разметка трассы
stage_2_excavation   // Вскопка/экскавация
stage_3_conduit      // Прокладка защитной трубы
stage_4_cable        // Прокладка кабеля
stage_5_splice       // Сплайсинг/соединение кабелей
stage_6_test         // Тестирование линии
stage_7_connect      // Подключение к НВТ
stage_8_final        // Финальная проверка
stage_9_backfill     // Засыпка траншеи
stage_10_surface     // Восстановление покрытия
```

Каждый этап может иметь несколько отчетов (например, разметка 50м сегодня, еще 50м завтра).

### 8. Работа с домами (House Connections)

#### 8.1 Просмотр домов
```
GET /nvt/{nvtId}/houses
→ Список домов для подключения:
  - Адрес
  - Количество подъездов
  - Количество квартир
  - Статус (pending/in_progress/connected)
  - Плановая дата подключения
  - Фактическая дата подключения
```

#### 8.2 Создание отчета о подключении дома
```typescript
POST /work_entries
{
  project_id: "uuid",
  cabinet_id: "uuid",
  house_id: "uuid",     // ID дома (вместо segment_id)
  user_id: "uuid",
  date: "2025-10-20",

  // Этапы подключения дома
  stage_code: "stage_7_connect",  // Подключение

  // Детали подключения
  meters_done_m: 15,  // Длина кабеля до дома
  method: "hand",
  cables_count: 1,

  notes: "Подключен дом, проложен кабель от НВТ",

  // Фотографии точки подключения, кабеля, и т.д.
  approved: false
}
```

### 9. Утверждение работ (Admin App)

В админ-приложении:
```typescript
// Бригадир/менеджер видит неутвержденные работы
GET /work_entries?approved=false

// Проверяет:
- Фотографии
- Замеры
- Объем работ
- Соответствие требованиям

// Утверждает
PATCH /work_entries/{id}
{
  approved: true,
  approved_by: "admin_user_id",
  approved_at: "2025-10-20T16:00:00Z"
}
```

### 10. Синхронизация данных

Worker PWA работает offline-first:

```
1. Работник создает отчет → сохраняется локально (IndexedDB)
2. При наличии интернета → синхронизируется с Supabase
3. Админ видит новые отчеты почти мгновенно
4. Утверждение → синхронизируется обратно в Worker PWA
5. Работник видит статус "Утверждено"
```

## Пример полного цикла работы

```
День 1:
- Работник выбрал проект "Жилой комплекс Север"
- Выбрал НВТ-005
- Создал сегмент "Улица Ленина, 100м"
- Создал отчет:
  * stage_1_marking (Разметка)
  * meters_done_m: 100
  * method: documentation
  * Прикрепил 5 фото разметки
- Создал отчет:
  * stage_2_excavation (Вскопка)
  * meters_done_m: 30
  * method: excavator
  * depth_m: 0.7, width_m: 0.4
  * Прикрепил 8 фото траншеи

День 2:
- Продолжил работу на том же сегменте
- Создал отчет:
  * stage_2_excavation
  * meters_done_m: 40
  * Прикрепил 6 фото

День 3:
- Завершил вскопку
- Создал отчет:
  * stage_2_excavation
  * meters_done_m: 30
- Начал прокладку трубы
- Создал отчет:
  * stage_3_conduit
  * meters_done_m: 50
  * has_protection_pipe: true

Админ:
- Проверил все отчеты
- Утвердил (approved: true)
- Работник получил уведомление об утверждении
```

## Схема базы данных (упрощенная)

```
projects (проекты)
  ↓
cabinets (НВТ точки)
  ↓
  ├─ segments (сегменты трассы)
  │    ↓
  │    work_entries (отчеты о работе на сегменте)
  │         ↓
  │         photos (фотографии работ)
  │
  └─ houses (дома для подключения)
       ↓
       work_entries (отчеты о подключении дома)
            ↓
            photos (фотографии подключения)
```

## RLS Политики

См. файл: `database/migrations/setup_rls_policies.sql`

Основные правила:
- Работники видят только проекты своих бригад
- Работники могут создавать отчеты только для своих проектов
- Работники могут редактировать только свои неутвержденные отчеты
- Утвержденные отчеты не могут быть изменены работниками
- Админы видят все данные

## Следующие шаги реализации

1. ✅ Создать RLS политики
2. ⏳ Применить политики в Supabase
3. ⏳ Создать UI для выбора сегмента
4. ⏳ Создать форму создания work_entry с выбором stage
5. ⏳ Создать форму добавления фотографий
6. ⏳ Создать список домов для подключения
7. ⏳ Создать форму отчета о подключении дома
8. ⏳ Протестировать синхронизацию с админ-приложением
