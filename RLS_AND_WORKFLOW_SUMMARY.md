# –†–µ–∑—é–º–µ: RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

## ‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï 2025-10-20: RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!

**–ü—Ä–æ–µ–∫—Ç:** world (oijmohlhdxoawzvctnxx)
**–ú–µ—Ç–æ–¥:** Supabase MCP
**–ú–∏–≥—Ä–∞—Ü–∏—è:** `fix_rls_allow_anon_access`

### –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
‚úÖ `houses` - RLS –≤–∫–ª—é—á–µ–Ω, –ø–æ–ª–∏—Ç–∏–∫–∞ `houses_allow_all_temp` (36 –∑–∞–ø–∏—Å–µ–π)
‚úÖ `segments` - RLS –≤–∫–ª—é—á–µ–Ω, –ø–æ–ª–∏—Ç–∏–∫–∞ `segments_allow_all_temp`
‚úÖ `work_entries` - RLS –≤–∫–ª—é—á–µ–Ω, –ø–æ–ª–∏—Ç–∏–∫–∞ `work_entries_allow_all_temp`
‚úÖ `photos` - RLS –≤–∫–ª—é—á–µ–Ω, –ø–æ–ª–∏—Ç–∏–∫–∞ `photos_allow_all_temp`

–í—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–∑—Ä–µ—à–∞—é—Ç –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø (`TO public`) –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

---

## üéØ –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (–†–ï–®–ï–ù–ê)

**–û—à–∏–±–∫–∞:** `Error fetching houses: {}`

**–ü—Ä–∏—á–∏–Ω–∞:** RLS (Row Level Security) –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ Worker PWA.

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã SQL –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º —á–µ—Ä–µ–∑ MCP.

---

## ‚ö° –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ SQL Editor

### 2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞:

üìÅ **`database/migrations/01_quick_fix_rls_existing_tables.sql`**

–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥:

```sql
-- HOUSES TABLE
ALTER TABLE public.houses ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "houses_allow_all_temp" ON public.houses;
CREATE POLICY "houses_allow_all_temp"
ON public.houses FOR ALL USING (true) WITH CHECK (true);

-- SEGMENTS TABLE
ALTER TABLE public.segments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "segments_allow_all_temp" ON public.segments;
CREATE POLICY "segments_allow_all_temp"
ON public.segments FOR ALL USING (true) WITH CHECK (true);

-- WORK_ENTRIES TABLE
ALTER TABLE public.work_entries ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "work_entries_allow_all_temp" ON public.work_entries;
CREATE POLICY "work_entries_allow_all_temp"
ON public.work_entries FOR ALL USING (true) WITH CHECK (true);

-- PHOTOS TABLE
ALTER TABLE public.photos ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "photos_allow_all_temp" ON public.photos;
CREATE POLICY "photos_allow_all_temp"
ON public.photos FOR ALL USING (true) WITH CHECK (true);
```

### 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Worker PWA
   - –û—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å
   - –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è

---

## üìã –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:
```
–ü—Ä–æ–µ–∫—Ç (Project)
  ‚îî‚îÄ –ù–í–¢/Cabinet (—Ç–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
      ‚îú‚îÄ –°–µ–≥–º–µ–Ω—Ç—ã —Ç—Ä–∞—Å—Å—ã (Segments) - –ø–æ ~100–º –∫–∞–∂–¥—ã–π
      ‚îÇ   ‚îî‚îÄ –û—Ç—á–µ—Ç—ã –æ —Ä–∞–±–æ—Ç–µ (Work Entries)
      ‚îÇ       ‚îî‚îÄ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (Photos)
      ‚îÇ
      ‚îî‚îÄ –î–æ–º–∞ (Houses) - –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          ‚îî‚îÄ –û—Ç—á–µ—Ç—ã –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (Work Entries)
              ‚îî‚îÄ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (Photos)
```

### Workflow:

1. **–†–∞–±–æ—Ç–Ω–∏–∫ –∑–∞—Ö–æ–¥–∏—Ç –≤ PWA**
   - –í—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç
   - –í—ã–±–∏—Ä–∞–µ—Ç –ù–í–¢ —Ç–æ—á–∫—É

2. **–†–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞—Å—Å–æ–π (Segments):**
   - –°–æ–∑–¥–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç —Ä–∞–±–æ—Ç—ã (~100–º —Ç—Ä–∞—Å—Å—ã)
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ —Å–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç:
     ```typescript
     {
       stage_code: "stage_2_excavation",  // –≠—Ç–∞–ø: –≤—Å–∫–æ–ø–∫–∞
       meters_done_m: 25.5,               // –°–¥–µ–ª–∞–Ω–æ –º–µ—Ç—Ä–æ–≤
       method: "excavator",               // –ú–µ—Ç–æ–¥: —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä
       depth_m: 0.7,                      // –ì–ª—É–±–∏–Ω–∞ —Ç—Ä–∞–Ω—à–µ–∏
       width_m: 0.4,                      // –®–∏—Ä–∏–Ω–∞ —Ç—Ä–∞–Ω—à–µ–∏
       photos: [...]                      // –§–æ—Ç–æ –¥–æ/–≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ
     }
     ```
   - –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤

3. **–†–∞–±–æ—Ç–∞ —Å –¥–æ–º–∞–º–∏ (Houses):**
   - –í—ã–±–∏—Ä–∞–µ—Ç –¥–æ–º –∏–∑ —Å–ø–∏—Å–∫–∞
   - –°–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:
     ```typescript
     {
       house_id: "uuid",
       stage_code: "stage_7_connect",
       meters_done_m: 15,  // –î–ª–∏–Ω–∞ –∫–∞–±–µ–ª—è –¥–æ –¥–æ–º–∞
       photos: [...]        // –§–æ—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
     }
     ```

4. **–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (Admin App):**
   - –ê–¥–º–∏–Ω/–±—Ä–∏–≥–∞–¥–∏—Ä –≤–∏–¥–∏—Ç –æ—Ç—á–µ—Ç—ã –≤ –¥—Ä—É–≥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ç–æ –∏ –¥–∞–Ω–Ω—ã–µ
   - –£—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: `approved: true`
   - –†–∞–±–æ—Ç–Ω–∏–∫ –≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ"

---

## üóÇÔ∏è 10 —ç—Ç–∞–ø–æ–≤ —Ä–∞–±–æ—Ç—ã (Stage Codes)

```typescript
stage_1_marking      // 1. –†–∞–∑–º–µ—Ç–∫–∞ —Ç—Ä–∞—Å—Å—ã
stage_2_excavation   // 2. –í—Å–∫–æ–ø–∫–∞/—ç–∫—Å–∫–∞–≤–∞—Ü–∏—è
stage_3_conduit      // 3. –ü—Ä–æ–∫–ª–∞–¥–∫–∞ –∑–∞—â–∏—Ç–Ω–æ–π —Ç—Ä—É–±—ã
stage_4_cable        // 4. –ü—Ä–æ–∫–ª–∞–¥–∫–∞ –∫–∞–±–µ–ª—è
stage_5_splice       // 5. –°–ø–ª–∞–π—Å–∏–Ω–≥/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
stage_6_test         // 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
stage_7_connect      // 7. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
stage_8_final        // 8. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
stage_9_backfill     // 9. –ó–∞—Å—ã–ø–∫–∞ —Ç—Ä–∞–Ω—à–µ–∏
stage_10_surface     // 10. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è
```

–ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–æ—ç—Ç–∞–ø–Ω–æ - —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç—ã.

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### SQL –º–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ `database/migrations/setup_rls_policies.sql`
  - –ü–æ–ª–Ω—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
  - –ü–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –±—Ä–∏–≥–∞–¥–µ

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `docs/WORKER_REPORTING_WORKFLOW.md`
  - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
  - –ü—Ä–∏–º–µ—Ä—ã API –∑–∞–ø—Ä–æ—Å–æ–≤
  - –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

- ‚úÖ `docs/QUICK_FIX_RLS.md`
  - –ë—ã—Å—Ç—Ä—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é RLS
  - –¢–µ—Å—Ç–æ–≤—ã–µ –∏ –ø—Ä–æ–¥–∞–∫—à–Ω –ø–æ–ª–∏—Ç–∏–∫–∏
  - –®–∞–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## ‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Worker PWA –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–æ–º–æ–≤ (houses) - 36 –∑–∞–ø–∏—Å–µ–π –¥–æ—Å—Ç—É–ø–Ω—ã
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (segments) - –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ UI:
5. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞/—Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
6. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è work_entry
7. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä stage_code (—ç—Ç–∞–ø–∞ —Ä–∞–±–æ—Ç—ã)
8. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π (meters, depth, width, method)
9. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
10. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ –¥–æ–º–æ–≤
11. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–º–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
12. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ Worker PWA
13. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Admin App
14. ‚è≥ –£—Ç–≤–µ—Ä–¥–∏—Ç—å –≤ Admin App
15. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ –≤ Worker PWA

### –ü—Ä–æ–¥–∞–∫—à–Ω:
16. ‚è≥ –ó–∞–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ
17. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
18. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å offline —Ä–µ–∂–∏–º

---

## üîß –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç:
- –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (768 –ø–∞–∫–µ—Ç–æ–≤)
- –ú–æ–∂–Ω–æ –∑–∞—Ö–æ–¥–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç—ã
- –ú–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –ù–í–¢ —Ç–æ—á–∫–∏
- –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å –ë–î
- –•—É–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –≥–æ—Ç–æ–≤—ã
- **RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ MCP (2025-10-20)**

### ‚ùå –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
- UI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏
- UI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤
- UI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ–º–∞–º–∏

### üìä –ü—Ä–æ–≥—Ä–µ—Å—Å:
- Backend/API: 90%
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏: 100% ‚úÖ **–ü–†–ò–ú–ï–ù–ï–ù–´**
- UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: 20%
- –§–æ—Ä–º—ã: 10%
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 0%

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: ~55%**

---

## üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ

**–õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø:** http://localhost:3001
**–°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø:** http://192.168.1.113:3001

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RLS –ø–æ–ª–∏—Ç–∏–∫ –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É UI –¥–ª—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏!
